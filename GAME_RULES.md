# Правила игры Perudo

Данный документ описывает условия игры Perudo, основанные на анализе кода проекта.

## Общие условия игры

### Начальные параметры

- **Количество игроков**: Настраивается (по умолчанию 4)
- **Кости на игрока**: 5 костей (настраивается через `dice_per_player`)
- **Значения костей**: от 1 до 6 (настраивается через `total_dice_values`)
- **Цель игры**: Последний оставшийся игрок с костями выигрывает

### Механика ставок (Bids)

**Ставка** представляет собой пару (количество, значение):
- **Количество** (quantity): число костей с указанным значением
- **Значение** (value): значение кости от 1 до 6

#### Правила повышения ставки

Ставка должна быть выше предыдущей. Новая ставка считается выше, если выполняется одно из условий:

1. **Больше количество** при любом значении
2. **Такое же количество, но больше значение**

#### Специальное правило для пасари (значение 1)

**Пасари** (1) считается как "двойное" значение любого другого числа:

- Если предыдущая ставка была **не пасари**, а новая ставка — **пасари**: требуется `количество >= (предыдущее_количество + 1) // 2`
- Если предыдущая ставка была **пасари**, а новая ставка — **не пасари**: требуется `количество >= предыдущее_количество * 2 + 1`
- Если обе ставки — **пасари**: требуется `количество > предыдущее_количество`

#### Подсчет костей при проверке

При проверке ставки учитываются:
- Все кости со значением, равным заявленному в ставке
- Все кости со значением 1 (пасари) считаются как любое значение, **кроме случая, когда ставка именно на единицы**

**Пример**: Если ставка "5x3" (5 костей со значением 3), то учитываются:
- Все кости со значением 3
- Все кости со значением 1 (пасари), которые считаются как 3

### Доступные действия

#### 1. Сделать ставку (Bid)

Игрок может сделать ставку, указав количество и значение костей.

**Требования для валидной ставки**:
- Количество должно быть положительным
- Значение должно быть в диапазоне от 1 до `total_dice_values`
- Ставка должна быть выше предыдущей (если есть предыдущая ставка)
- Количество не может превышать общее число костей всех игроков
- Игрок должен быть в игре (иметь хотя бы одну кость)

#### 2. Вызов (Challenge)

Игрок может вызвать предыдущего игрока, если считает, что его ставка неверна.

**Механика вызова**:
- Проверяется фактическое количество костей с указанным значением (включая пасари)
- Если фактическое количество **меньше** заявленного: вызов **успешен**, игрок, сделавший ставку, теряет одну кость
- Если фактическое количество **больше или равно** заявленному: вызов **неуспешен**, вызывающий игрок теряет одну кость

**Требования**:
- Должна быть предыдущая ставка
- Игрок должен быть в игре

#### 3. Пакао (Pacao)

Игрок может вызвать "пакао" — все игроки показывают свои кости.

**Требования для вызова пакао**:
- Игрок должен иметь **ровно одну кость**
- Должна быть предыдущая ставка
- Пакао может быть вызвано только один раз за раунд

**Механика пакао**:
- Все игроки показывают свои кости
- Проверяется фактическое количество костей с указанным значением
- Если фактическое количество **больше или равно** заявленному: пакао **успешно**, игрок, сделавший ставку, теряет одну кость
- Если фактическое количество **меньше** заявленного: пакао **неуспешно**, вызывающий игрок теряет одну кость

### Специальные правила

#### Пальфико (Palifico)

**Активируется автоматически** для игрока, когда у него остается **одна кость** в начале раунда.

**Ограничения**:
- Игрок в пальфико **не может менять значение** в своей ставке
- Может повышать только **количество** при том же значении, что и предыдущая ставка

**Пример**: Если предыдущая ставка была "3x4", игрок в пальфико может сделать "4x4", "5x4", но **не может** сделать "3x5" или "4x6".

### Проверка валидности ставки

Ставка считается валидной, если выполнены все условия:

1. ✅ Это ход игрока
2. ✅ Количество > 0
3. ✅ Значение в диапазоне 1-6
4. ✅ Игрок еще в игре (имеет кости)
5. ✅ Ставка выше предыдущей (если есть предыдущая ставка)
6. ✅ Для игрока в пальфико: значение не меняется
7. ✅ Количество не превышает общее число костей всех игроков

### Ход игры

#### Начало раунда

1. Бросаются кости для всех игроков (количество костей соответствует текущему состоянию игрока)
2. Автоматически активируется пальфико для игроков с одной костью
3. Текущая ставка сбрасывается
4. Флаг пакао сбрасывается
5. Ход переходит к первому игроку (или к игроку, следующему после проигравшего в предыдущем раунде)

#### Последовательность ходов

- Ходы передаются по кругу
- Игроки без костей автоматически пропускаются
- Если остался только один игрок с костями, игра завершается

#### Завершение раунда

Раунд завершается при вызове (challenge) или пакао (pacao):

1. Определяется проигравший (игрок, который теряет кость)
2. Проигравший теряет одну кость
3. Текущая ставка сбрасывается
4. Флаг пакао сбрасывается
5. Новый раунд начинается с игрока, следующего после проигравшего
6. Кости перебрасываются для всех игроков

#### Завершение игры

Игра завершается, когда:
- У всех игроков, кроме одного, закончились кости (количество костей = 0)
- Победитель — последний оставшийся игрок с костями

### Ограничения и валидация

#### Максимальное количество в ставке

- Количество не может превышать **общее число костей всех игроков** в текущий момент
- Это учитывает возможное влияние пасари, но не позволяет делать нереалистичные ставки

#### Игрок вне игры

- Игрок без костей не может делать никаких действий
- Такие игроки автоматически пропускаются при переходе хода

#### Первая ставка

- Первая ставка в раунде может быть любой валидной (любое количество от 1 до максимума, любое значение от 1 до 6)

### Информация в игре

#### Публичная информация (видят все игроки)

- Текущая ставка (количество, значение)
- История ставок (кто сделал, количество, значение)
- Текущий игрок
- Количество костей у каждого игрока
- Статус пальфико для каждого игрока
- Флаг пакао (было ли вызвано)

#### Скрытая информация (приватная)

- Конкретные значения костей каждого игрока (кроме своих собственных)

Каждый игрок видит только свои кости, но не кости других игроков. Это создает элемент блефа и неполной информации, который является ключевым аспектом игры Perudo.

### Примеры игры

#### Пример 1: Обычная ставка

- Игрок 1: "3x4" (3 кости со значением 4)
- Игрок 2: "4x4" (4 кости со значением 4) ✅ — больше количество
- Игрок 3: "4x5" (4 кости со значением 5) ✅ — такое же количество, больше значение

#### Пример 2: Пасари

- Игрок 1: "5x3" (5 костей со значением 3)
- Игрок 2: "3x1" (3 кости со значением 1) ✅ — пасари считается как двойное, поэтому 3 пасари ≥ 5 обычных

#### Пример 3: Пальфико

- Предыдущая ставка: "3x4"
- Игрок в пальфико: "4x4" ✅ — можно (больше количество, то же значение)
- Игрок в пальфико: "3x5" ❌ — нельзя (изменено значение)

#### Пример 4: Вызов

- Игрок 1: "8x3" (8 костей со значением 3)
- Игрок 2: вызывает
- Фактически на столе: 6 костей со значением 3 + 2 пасари (считаются как 3) = 8 костей
- Результат: вызов неуспешен, Игрок 2 теряет кость

#### Пример 5: Пакао

- Игрок 1: "10x5"
- Игрок 2 (с 1 костью): вызывает пакао
- Все показывают кости
- Фактически: 11 костей со значением 5 (включая пасари)
- Результат: пакао успешно (11 ≥ 10), Игрок 1 теряет кость

---

**Примечание**: Данное описание основано исключительно на анализе кода проекта и может отличаться от классических правил Perudo в некоторых деталях. Все правила реализованы в файлах:
- `src/perudo/game/rules.py` — правила валидации
- `src/perudo/game/game_state.py` — состояние игры и механика
- `src/perudo/game/perudo_env.py` — среда для обучения

