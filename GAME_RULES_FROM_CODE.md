# Условия игры Perudo (на основе анализа кода)

**Примечание:** Данное описание условий игры составлено на основе анализа существующего кода проекта. Все правила и механизмы описаны в соответствии с реализацией, найденной в коде.

## Общие параметры игры

Игра рассчитана на несколько игроков (по умолчанию 4). Каждый игрок начинает игру с 5 кубиками. Кубики имеют значения от 1 до 6. Игроки не видят кубики друг друга — каждый видит только свои собственные кубики.

## Начало игры и раунды

В начале игры каждый игрок бросает свои кубики. Раунд начинается с первого игрока по очереди. Ход передаётся по кругу. Игроки, у которых осталось 0 кубиков, пропускаются в очереди.

## Типы действий

В свой ход игрок может выполнить одно из следующих действий:
1. **Сделать ставку** — объявить количество кубиков определённого значения
2. **Оспорить ставку** — усомниться в правильности предыдущей ставки
3. **Вызвать пакао** — специальное действие, доступное только игрокам с одним кубиком

## Ставки (Bids)

Ставка состоит из двух параметров: **количество** (quantity) и **значение** (value). Например, ставка "3x5" означает, что игрок считает, что на столе есть минимум 3 кубика со значением 5.

### Первая ставка в раунде

Первая ставка в раунде может быть любой — игрок может назвать любое количество от 1 до общего количества кубиков всех игроков и любое значение от 1 до 6.

### Правила повышения ставок

Каждая последующая ставка должна быть выше предыдущей. Правила определения "выше" следующие:

1. **Общее правило для обычных ставок:**
   - Количество может только увеличиваться
   - Если количество остаётся прежним, значение должно увеличиться
   - Если количество увеличивается, можно назвать любое значение

2. **Специальное правило для ставок на единицы (pasari):**
   - Если предыдущая ставка была на единицы (value = 1), то новая ставка может быть:
     - Увеличение количества единиц (value = 1, quantity > предыдущее количество), ИЛИ
     - Другое значение с количеством, равным минимум 2 × предыдущее_количество + 1
   
   - Если предыдущая ставка была НЕ на единицы, а новая ставка на единицы, то:
     - Количество можно уменьшить до половины (с округлением вверх)
     - Минимальное количество = (предыдущее_количество + 1) // 2

### Ограничения на ставки

- Количество не может превышать общее количество кубиков всех игроков на столе
- Значение должно быть от 1 до 6
- Ставка должна быть выше предыдущей (согласно правилам выше)

## Специальные раунды

### Специальный раунд (Special Round)

Специальный раунд активируется автоматически, когда хотя бы у одного игрока остаётся только 1 кубик. В этом раунде действуют особые правила:

1. **Единицы не являются джокерами** — единицы считаются только как единицы, а не как любое значение
2. **Нельзя менять значение** — после первой ставки в специальном раунде все последующие ставки должны быть на то же значение

### Паличико (Palifico)

Если у игрока остаётся 1 кубик, для него активируется статус "паличико". Это означает, что в следующем раунде, который станет специальным раундом, этот игрок должен соблюдать правила специального раунда.

## Подсчёт кубиков

### В обычном раунде

- Единицы (значение 1) являются джокерами и считаются как любое значение, кроме случаев, когда ставка делается именно на единицы
- При подсчёте кубиков со значением X учитываются:
  - Все кубики со значением X
  - Все кубики со значением 1 (если X ≠ 1)

### В специальном раунде

- Единицы НЕ являются джокерами
- При подсчёте кубиков со значением X учитываются только кубики со значением X (точное совпадение)

## Оспаривание ставки (Challenge)

Любой игрок в свой ход может оспорить предыдущую ставку. Для этого нужно выполнить действие "challenge".

### Процесс оспаривания

1. Игрок объявляет оспаривание
2. Все игроки показывают свои кубики
3. Подсчитывается фактическое количество кубиков с заявленным значением (с учётом правил специального раунда)
4. Результат определяется:
   - Если фактическое количество < заявленного количества: оспаривание успешно (ставка была неправильной)
   - Если фактическое количество ≥ заявленного количества: оспаривание неудачно (ставка была правильной)

### Последствия оспаривания

- Если оспаривание успешно: игрок, сделавший ставку, теряет 1 кубик
- Если оспаривание неудачно: игрок, оспоривший ставку, теряет 1 кубик

После оспаривания раунд заканчивается, все игроки снова бросают кубики, и новый раунд начинается с игрока, следующего за проигравшим.

## Пакао (Pacao)

Пакао — это специальное действие, доступное только игрокам, у которых остался 1 кубик.

### Условия вызова пакао

- Игрок должен иметь ровно 1 кубик
- На столе должна быть активная ставка
- Пакао ещё не был вызван в этом раунде

### Процесс пакао

1. Игрок объявляет пакао
2. Все игроки показывают свои кубики
3. Подсчитывается фактическое количество кубиков с заявленным значением
4. Результат определяется:
   - Если фактическое количество ≥ заявленного количества: пакао успешно (ставка была правильной)
   - Если фактическое количество < заявленного количества: пакао неудачно (ставка была неправильной)

### Последствия пакао

- Если пакао успешно: игрок, сделавший ставку, теряет 1 кубик
- Если пакао неудачно: игрок, вызвавший пакао, теряет 1 кубик

После пакао раунд заканчивается, все игроки снова бросают кубики, и новый раунд начинается с игрока, следующего за проигравшим.

## Окончание раунда

Раунд заканчивается, когда:
- Игрок оспорил ставку
- Игрок вызвал пакао

После окончания раунда:
- Один из игроков теряет 1 кубик (в зависимости от результата)
- Все игроки снова бросают свои кубики
- Новый раунд начинается с игрока, следующего за проигравшим
- Если проигравший был активным игроком, ход передаётся следующему игроку
- Если проигравший не был активным игроком, ход начинается с игрока, следующего за проигравшим

## Окончание игры

Игра заканчивается, когда остаётся только один игрок с кубиками. Этот игрок объявляется победителем.

Игроки с 0 кубиков считаются выбывшими и не участвуют в дальнейшей игре. Они автоматически пропускаются при передаче хода.

## Ход игрового процесса

### Типичный раунд

1. **Начало раунда**: Все игроки бросают свои кубики. Определяется, является ли раунд специальным (если хотя бы у одного игрока 1 кубик).

2. **Фаза ставок**: 
   - Первый игрок делает начальную ставку
   - Следующие игроки по очереди либо повышают ставку, либо оспаривают предыдущую ставку, либо вызывают пакао (если у них 1 кубик)
   - Ставки продолжаются до тех пор, пока кто-то не оспорит ставку или не вызовет пакао

3. **Завершение раунда**:
   - При оспаривании или пакао все игроки показывают кубики
   - Подсчитывается фактическое количество
   - Определяется проигравший (тот, кто ошибся)
   - Проигравший теряет 1 кубик

4. **Переход к следующему раунду**:
   - Если игра не закончилась, начинается новый раунд с броска кубиков
   - Ход начинается с игрока, следующего за проигравшим

### Стратегические элементы

- **Блеф**: Игроки могут делать ставки, которые не соответствуют их кубикам, надеясь, что их не оспорят
- **Оспаривание**: Игроки должны решать, когда стоит рискнуть и оспорить ставку
- **Специальные раунды**: Когда у кого-то остаётся 1 кубик, правила меняются — единицы перестают быть джокерами, что влияет на подсчёты
- **Пакао**: Игроки с одним кубиком имеют дополнительный способ завершить раунд и проверить ставку

## Дополнительные правила

### Передача хода

Ход передаётся по кругу от игрока к игроку. Игроки с 0 кубиков автоматически пропускаются. Если остаётся только один игрок с кубиками, игра немедленно заканчивается.

### Видимость информации

- **Скрытая информация**: Игроки видят только свои собственные кубики
- **Публичная информация**: 
  - Количество кубиков у каждого игрока
  - История всех ставок (кто, что и когда поставил)
  - Текущая активная ставка
  - Статус специального раунда
  - Статус паличико для каждого игрока
  - Текущий игрок

### Валидация действий

Все действия проверяются на валидность:
- Игрок может действовать только в свой ход
- Ставки должны быть выше предыдущих
- В специальном раунде нельзя менять значение ставки
- Пакао могут вызывать только игроки с 1 кубиком
- Оспаривать можно только если есть предыдущая ставка

