# Code Review: `perudo_vec_env.py`

## Найденные проблемы

### 1. Неиспользуемый код

#### 1.1 Неиспользуемые импорты
- **`calculate_reward`** (строка 43-45): Импортируется, но никогда не используется в файле
- **`spaces`** (строка 10): Импортируется из `gymnasium`, но не используется
- **`debug_moves`** (строка 74): Параметр конструктора, который не сохраняется и не используется (только комментарий)

#### 1.2 Неиспользуемые переменные
- **`self.last_obs`** (строки 214, 365, 371, 1422): Переменная записывается, но никогда не читается. `action_masks()` всегда получает наблюдения заново через `env.get_observation_for_player(0)`
- **`self.episode_info`** (строки 183, 291, 973): Записывается, но никогда не читается
- **`self.all_agents_episode_reward`** (строки 197-199, 296, 977, 1007, 1038): Инициализируется и очищается, но никогда не используется для чтения
- **`bot_names`** (строки 426-450): Создается и заполняется, но используется только в закомментированном коде

### 2. Дублирующийся код

#### 2.1 Сброс статистики эпизода (дублируется в 4 местах)
Код сброса статистики повторяется в:
- `reset()` строки 292-301
- `step_wait()` строки 975-980
- `step_wait()` строки 1005-1009 (в цикле)
- `step_wait()` строки 1036-1040 (в цикле)

**Рекомендация**: Вынести в метод `_reset_episode_statistics(env_idx: int)`

#### 2.2 Сброс счетчиков ботов (дублируется в 3 местах)
Код сброса `bot_steps` повторяется в:
- `step_wait()` строки 962-965
- `step_wait()` строки 996-998 (в цикле)
- `step_wait()` строки 1027-1029 (в цикле)

**Рекомендация**: Вынести в метод `_reset_bot_steps(env_idx: int, num_players: int)`

#### 2.3 Продвижение до хода обучающего агента (дублируется в 2 местах)
Очень похожая логика в:
- `reset()` строки 303-343
- `step_wait()` строки 982-1042

**Рекомендация**: Вынести в метод `_advance_to_learning_agent(env_idx: int, env: PerudoEnv, seeds: Optional[List[int]], options: Optional[List[Dict]], opponent_snapshot_ids: Optional[List[Optional[str]]])`

#### 2.4 Преобразование observations (дублируется в 2 местах)
Код преобразования списка наблюдений в dict/array повторяется:
- `reset()` строки 353-372
- `step_wait()` строки 1410-1422

**Рекомендация**: Вынести в метод `_convert_observations_to_vec_format(observations_list: List)`

#### 2.5 Избыточные проверки в `action_masks()`
Множественные проверки валидности масок:
- Строки 1539-1553: Проверка на отсутствие валидных действий + fallback
- Строки 1555-1565: Еще одна проверка на отсутствие валидных действий (дубликат)
- Строки 1571-1583: Проверка на 1 валидное действие
- Строки 1610-1644: Проверка в массиве масок (частичный дубликат)
- Строки 1646-1654: Проверка типа boolean массива
- Строки 1656-1694: Финальная проверка на минимум 5 валидных действий

**Проблема**: Многие проверки дублируют друг друга, код избыточен и сложен для поддержки.

**Рекомендация**: Упростить логику, убрать дублирующиеся проверки, создать единую функцию валидации масок.

### 3. Избыточный код

#### 3.1 Избыточные комментарии "CRITICAL"
В коде более 20 комментариев с пометкой "CRITICAL". Многие из них повторяют одну и ту же информацию о синхронизации `active_agent_ids` с `game_state.current_player`.

**Рекомендация**: Оставить только действительно критичные комментарии, общую логику описать в docstring методов.

#### 3.2 Избыточные валидации
- `_validate_active_agent_id()` вызывается очень часто (более 10 раз в одном проходе `step_wait()`)
- Некоторые проверки выполняются несколько раз подряд

**Рекомендация**: Оптимизировать количество валидаций, проверять только в критических точках.

#### 3.3 Повторяющийся код сброса окружения
В `step_wait()` в строках 992-1010 и 1023-1041 код практически идентичен:
- Сброс окружения
- Сброс счетчиков ботов
- Выборка противников
- Синхронизация
- Сброс статистики

**Рекомендация**: Вынести в отдельный метод `_reset_environment_for_new_episode(env_idx: int, env: PerudoEnv, seeds: Optional[List[int]], options: Optional[List[Dict]], opponent_snapshot_ids: Optional[List[Optional[str]]])`

#### 3.4 Дублирование логики обработки action_mask в `_execute_opponent_move()`
Код извлечения и обработки `action_mask` (строки 710-722) похож на код в `action_masks()`, но реализован отдельно.

**Рекомендация**: Вынести в вспомогательный метод `_extract_action_mask(obs: Any) -> Optional[np.ndarray]`

### 4. Потенциальные улучшения

#### 4.1 Упрощение `update_opponent_models_for_current_model()`
Метод содержит дублирующийся код (строки 575-578 и 581-584 практически идентичны).

**Рекомендация**: Упростить:
```python
# Текущий код дублируется
if self.opponent_pool is None:
    for opp_idx in range(1, num_players):
        if opp_idx - 1 < len(self.opponent_models[env_idx]):
            self.opponent_models[env_idx][opp_idx - 1] = self.current_model
            self.opponent_paths[env_idx][opp_idx - 1] = None
elif not self.opponent_pool.snapshots:
    for opp_idx in range(1, num_players):
        if opp_idx - 1 < len(self.opponent_models[env_idx]):
            self.opponent_models[env_idx][opp_idx - 1] = self.current_model
            self.opponent_paths[env_idx][opp_idx - 1] = None

# Можно упростить до:
if self.opponent_pool is None or not self.opponent_pool.snapshots:
    for opp_idx in range(1, num_players):
        if opp_idx - 1 < len(self.opponent_models[env_idx]):
            self.opponent_models[env_idx][opp_idx - 1] = self.current_model
            self.opponent_paths[env_idx][opp_idx - 1] = None
```

#### 4.2 Неиспользуемая переменная `actual_num_players`
В `reset()` на строке 307 переменная `actual_num_players` переопределяется, хотя уже была получена на строке 274.

### 5. Итого

#### Найденные проблемы:
- **Неиспользуемый код**: 8 элементов (импорты, переменные)
- **Дублирующийся код**: 5 основных блоков
- **Избыточный код**: множественные проверки, комментарии, валидации

#### Оценка влияния:
- **Производительность**: Минимальное (неиспользуемые переменные не влияют на производительность)
- **Читаемость**: Высокое (дублирующийся код усложняет понимание и поддержку)
- **Поддержка**: Высокое (изменения нужно вносить в нескольких местах)
- **Размер кода**: ~200 строк можно оптимизировать

#### Приоритет рефакторинга:
1. **Высокий**: Вынести дублирующийся код сброса статистики и продвижения до хода агента
2. **Средний**: Упростить `action_masks()`, убрать избыточные проверки
3. **Низкий**: Удалить неиспользуемые импорты и переменные


